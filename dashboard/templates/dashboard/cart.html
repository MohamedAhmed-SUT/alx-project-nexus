{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}My Cart - E-Commerce Dashboard{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #2563eb;
        --secondary-color: #64748b;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --dark-color: #1e293b;
        --light-color: #f8fafc;
        --border-radius: 12px;
        --box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        --transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    .main-container {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin: 2rem auto;
        padding: 2rem;
        max-width: 1400px;
    }
    .card {border:none; border-radius: var(--border-radius); box-shadow: var(--box-shadow); transition: var(--transition); overflow:hidden;}
    .card:hover {transform: translateY(-5px); box-shadow:0 10px 25px -5px rgba(0,0,0,0.2);}
    .btn {border-radius:8px; font-weight:500; transition: var(--transition); border:none; position:relative; overflow:hidden;}
    .btn::before {content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent); transition:left 0.5s;}
    .btn:hover::before {left:100%;}
    .btn-primary {background:linear-gradient(45deg,#3b82f6,#1d4ed8);}
    .btn-success {background:linear-gradient(45deg,#10b981,#059669);}
    .btn-warning {background:linear-gradient(45deg,#f59e0b,#d97706);}
    .btn-danger {background:linear-gradient(45deg,#ef4444,#dc2626);}
    .table {background:white; border-radius: var(--border-radius); overflow:hidden; box-shadow: var(--box-shadow);}
    .table th {background: linear-gradient(45deg,#1e293b,#334155); color:white; font-weight:600; border:none; padding:1rem;}
    .table td {padding:1rem; vertical-align:middle; border-color:#e2e8f0;}
    .table tbody tr {transition: var(--transition);}
    .table tbody tr:hover {background-color:#f8fafc; transform:scale(1.01);}
    .form-control, .form-select {border-radius:8px; border:2px solid #e2e8f0; transition:var(--transition); padding:0.75rem 1rem;}
    .form-control:focus, .form-select:focus {border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.1); transform:translateY(-1px);}
    .fade-in {animation:fadeIn 0.6s ease-out;}
    @keyframes fadeIn {from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);}}
    .cart-item-image {width:80px; height:80px; object-fit:cover; border-radius:8px;}
    .quantity-control {display:flex; align-items:center;}
    .quantity-btn {width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px; background:#f1f5f9; border:1px solid #e2e8f0; cursor:pointer; transition:var(--transition);}
    .quantity-btn:hover {background:#e2e8f0;}
    .quantity-input {width:50px; text-align:center; margin:0 8px; border:1px solid #e2e8f0; border-radius:6px; padding:4px;}
    .empty-cart {text-align:center; padding:3rem;}
    .empty-cart-icon {font-size:4rem; color:#cbd5e1; margin-bottom:1rem;}
    .summary-card {position:sticky; top:20px;}
    @media(max-width:768px) {
        .main-container {margin:1rem; padding:1rem;}
        .cart-item-image {width:60px; height:60px;}
        .table-responsive {font-size:0.875rem;}
    }
</style>

<div class="main-container fade-in">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold"><i class="fas fa-shopping-cart me-2"></i>My Cart</h1>
            <p class="text-muted">Review and manage your shopping cart items</p>
        </div>
    </div>
    {% if items %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Cart Items</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr data-item-id="{{ item.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if item.product.image %}
                                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="cart-item-image me-3">
                                            {% else %}
                                                <div class="cart-item-image me-3 d-flex align-items-center justify-content-center bg-light text-secondary" style="font-size:2rem; border-radius:8px;">
                                                    <i class="fas fa-box"></i>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-0">{{ item.product.name }}</h6>
                                                <small class="text-muted">SKU: {{ item.product.sku|default:"N/A" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="price">${{ item.product.price|floatformat:2 }}</td>
                                    <td>
                                        <div class="quantity-control">
                                            <button class="quantity-btn decrease" data-item-id="{{ item.id }}">-</button>
                                            <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" data-item-id="{{ item.id }}">
                                            <button class="quantity-btn increase" data-item-id="{{ item.id }}">+</button>
                                        </div>
                                    </td>
                                    <td class="total">${{ item.total_price|floatformat:2 }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger remove-item" data-item-id="{{ item.id }}" data-url="{% url 'remove_from_cart' item.id %}">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <a href="{% url 'shop' %}" class="btn btn-outline-primary"><i class="fas fa-arrow-left me-2"></i>Continue Shopping</a>
                <button class="btn btn-outline-danger" id="clear-cart" data-url="{% url 'clear_cart' %}">
                    <i class="fas fa-trash me-2"></i>Clear Cart
                </button>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card summary-card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="subtotal">${{ cart.total_price|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping:</span>
                        <span>$5.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax:</span>
                        <span>${{ cart.tax|default:"0.00"|floatformat:2 }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Total:</strong>
                        <strong id="total">${{ cart.total_with_shipping|floatformat:2 }}</strong>
                    </div>
                    <form method="post" action="{% url 'checkout' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary w-100 py-2 mb-3"><i class="fas fa-lock me-2"></i>Proceed to Checkout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body empty-cart">
            <div class="empty-cart-icon"><i class="fas fa-shopping-cart"></i></div>
            <h4>Your cart is empty</h4>
            <p class="text-muted mb-4">Looks like you haven't added any items to your cart yet.</p>
            <a href="{% url 'shop' %}" class="btn btn-primary"><i class="fas fa-shopping-bag me-2"></i>Start Shopping</a>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function updateTotals() {
        let subtotal = 0;
        document.querySelectorAll('tbody tr').forEach(row => {
            const price = parseFloat(row.querySelector('.price').textContent.replace('$',''));
            const qty = parseInt(row.querySelector('.quantity-input').value);
            const total = price * qty;
            row.querySelector('.total').textContent = '$'+total.toFixed(2);
            subtotal += total;
        });
        document.getElementById('subtotal').textContent = '$'+subtotal.toFixed(2);
        const shipping = 5;
        const tax = parseFloat('{{ cart.tax|default:"0.00" }}');
        document.getElementById('total').textContent = '$'+(subtotal+shipping+tax).toFixed(2);
    }

    document.querySelectorAll('.quantity-btn.increase').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            const max = parseInt(input.max);
            const newQty = parseInt(input.value) + 1;
            if (newQty <= max) {
                input.value = newQty;
                fetch('/api/cart/update-quantity/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ item_id: itemId, quantity: newQty })
                })
                .then(res => res.json())
                .then(data => {
                    updateTotals();
                })
                .catch(err => console.error(err));
            }
        });
    });

    document.querySelectorAll('.quantity-btn.decrease').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            const newQty = parseInt(input.value) - 1;
            if (newQty >= 1) {
                input.value = newQty;
                fetch('/api/cart/update-quantity/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ item_id: itemId, quantity: newQty })
                })
                .then(res => res.json())
                .then(data => {
                    updateTotals();
                })
                .catch(err => console.error(err));
            }
        });
    });

    document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.dataset.url;
            const row = this.closest('tr');
            const itemName = row.querySelector('h6').textContent;

            Swal.fire({
                title: `Remove "${itemName}"?`,
                text: "This action cannot be undone.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Yes, remove it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(url, {
                        method: 'POST',
                        headers: {'X-CSRFToken': csrftoken}
                    })
                    .then(res => window.location.reload())
                    .catch(err => console.error(err));
                }
            });
        });
    });

    document.getElementById('clear-cart').addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.dataset.url;

        Swal.fire({
            title: 'Clear your cart?',
            text: "All items will be removed.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Yes, clear it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(url, {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken}
                })
                .then(res => window.location.reload())
                .catch(err => console.error(err));
            }
        });
    });

    document.querySelector('form[action="{% url 'checkout' %}"]').addEventListener('submit', function(e) {
        e.preventDefault();
        const url = this.action;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(res => res.json())
        .then(data => {
            Swal.fire({
                title: 'Success!',
                text: 'Checkout completed successfully!',
                icon: 'success',
                confirmButtonColor: '#10b981',
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.href = '{% url "shop" %}';
            });
        })
        .catch(err => {
            Swal.fire({
                title: 'Error',
                text: 'Something went wrong during checkout.',
                icon: 'error',
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'OK'
            });
            console.error(err);
        });
    });

    updateTotals();
});
</script>
{% endblock %}